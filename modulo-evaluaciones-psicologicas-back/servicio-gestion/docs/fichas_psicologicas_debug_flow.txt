Guia de pruebas para fichas psicologicas
======================================

Variables base
--------------
- BASE_URL = https://<host>/servicio-gestion
- TOKEN = JWT con rol PSICOLOGO (recomendado) u ADMINISTRADOR
- HEADER Authorization: Bearer {{TOKEN}}
- HEADER Content-Type: application/json
- HEADER Accept: application/json

Prerequisitos rapidos
---------------------
1. Validar que exista el psicologo autenticado:
   - GET {{BASE_URL}}/api/psicologos -> confirmar que el id esperado aparece.
2. Confirmar que existe el personal militar a evaluar:
   - GET {{BASE_URL}}/api/personal-militar -> ubicar el id que usara en la ficha.
   - Si no existe, crear con POST {{BASE_URL}}/api/personal-militar y el payload de ejemplo del paso 0.
3. Tener a mano los enums validos (ver ficha_psicologica_postman.txt en este mismo directorio).

Paso 0. Crear/actualizar personal militar (solo si hace falta)
--------------------------------------------------------------
POST {{BASE_URL}}/api/personal-militar
{
  "cedula": "0102030405",
  "apellidos": "Perez Garcia",
  "nombres": "Luis Alberto",
  "fechaNacimiento": "1990-05-21",
  "grado": "SGOS",
  "arma": "INF",
  "unidad": "BATALLON 1",
  "estadoCivil": "Casado",
  "sexo": "Masculino",
  "telefono": "0999999999",
  "correo": "luis.perez@example.mil",
  "etnia": "Mestizo",
  "seguro": "IESS"
}
Respuesta esperada: 201 con el id del nuevo militar. Conservarlo como {{PERSONAL_ID}}.

Paso 1. Crear la ficha (datos generales)
---------------------------------------
POST {{BASE_URL}}/api/fichas-psicologicas
{
  "personalMilitarId": {{PERSONAL_ID}},
  "fechaEvaluacion": "2025-01-07",
  "tipoEvaluacion": "Ingreso",
  "estado": "Abierta"
}
Respuesta esperada: 201 con campos id y numeroEvaluacion. Guardar {{FICHA_ID}} y {{NUMERO}}.
Si responde 404 o 422, revisar que el personal exista y que los enums sean validos.

Paso 2. Verificar lectura inmediata
-----------------------------------
GET {{BASE_URL}}/api/fichas-psicologicas/{{FICHA_ID}}
Comprobar que estado = Abierta y que personalMilitar.id coincide. Si no carga, revisar logs.

Paso 3. Guardar seccion de observacion
--------------------------------------
PUT {{BASE_URL}}/api/fichas-psicologicas/{{FICHA_ID}}/observacion
{
  "observacionClinica": "Paciente refiere cefaleas frecuentes",
  "motivoConsulta": "Reubicacion operativa",
  "enfermedadActual": "Cefalea tensional recurrente"
}
Respuesta esperada: 200 y observacionClinica no nulo. Si devuelve 403 verificar rol del token.

Paso 4. Guardar seccion de psicoanamnesis
-----------------------------------------
PUT {{BASE_URL}}/api/fichas-psicologicas/{{FICHA_ID}}/psicoanamnesis
{
  "prenatal": {
    "condicionesBiologicasPadres": "Sin antecedentes relevantes",
    "condicionesPsicologicasPadres": "Estables",
    "observacion": "Gestacion controlada"
  },
  "natal": {
    "partoNormal": true,
    "termino": "A termino",
    "complicaciones": null,
    "observacion": "Sin complicaciones"
  },
  "infancia": {
    "gradoSociabilidad": "Comunicativo",
    "relacionPadresHermanos": "Asertiva",
    "discapacidadIntelectual": false,
    "gradoDiscapacidad": "Ninguna",
    "trastornos": "N/A",
    "tratamientosPsicologicosPsiquiatricos": false,
    "observacion": "Desarrollo acorde"
  }
}
Respuesta esperada: 200 con las subsecciones pobladas. Si la estructura prenatal/natal/infancia falta, la validacion fallara en 400.

Paso 5. Definir condicion clinica y plan
---------------------------------------
PUT {{BASE_URL}}/api/fichas-psicologicas/{{FICHA_ID}}/condicion
{
  "condicion": "Seguimiento (Requiere citas periodicas)",
  "diagnosticoCie10Codigo": "F32.0",
  "diagnosticoCie10Descripcion": "Episodio depresivo leve",
  "planFrecuencia": "Quincenal",
  "planTipoSesion": "Individual",
  "planDetalle": "Sesiones quincenales"
}
Respuesta esperada: 200, condicionClinica = Seguimiento..., planSeguimiento.* llenos. Para Alta, enviar solo "condicion": "No presenta psicopatologia (Alta)".

Paso 6. Cambiar estado administrativo
-------------------------------------
PATCH {{BASE_URL}}/api/fichas-psicologicas/{{FICHA_ID}}/estado
{
  "estado": "En seguimiento"
}
Respuesta esperada: 200 con estado actualizado. Si no cambia, verificar que el campo "estado" exista en el JSON y este en el enum EstadoFichaEnum.

Paso 7. Finalizar ficha
-----------------------
POST {{BASE_URL}}/api/fichas-psicologicas/{{FICHA_ID}}/finalizar
Respuesta esperada: 200 con estado = Cerrada o el valor final configurado en el servicio. Si genera 409, revise que la condicion clinica sea valida para cierre.

Paso 8. Listado por filtros basicos
-----------------------------------
GET {{BASE_URL}}/api/fichas-psicologicas?psicologoId={{PSICOLOGO_ID}}&personalMilitarId={{PERSONAL_ID}}&soloActivas=true
La respuesta debe incluir la ficha creada mientras no este archivada. Si el arreglo es vacio, revisar que soloActivas corresponda al estado actual.

Paso 9. Historial por personal
------------------------------
GET {{BASE_URL}}/api/fichas-psicologicas/historial/{{PERSONAL_ID}}
Esperado: arreglo ordenado por fecha con la ficha actual al inicio. Usar este paso para detectar fichas duplicadas o estados inconsistentes.

Paso 10. Seguimiento psicologico asociado (opcional)
----------------------------------------------------
1) Crear seguimiento: POST {{BASE_URL}}/api/seguimientos-psicologicos
{
  "fichaPsicologicaId": {{FICHA_ID}},
  "fecha": "2025-01-14",
  "tipoSesion": "Individual",
  "frecuencia": "Quincenal",
  "detalleSesion": "Sesion de seguimiento",
  "recomendaciones": "Continuar plan"
}
2) Listar seguimientos por ficha: GET {{BASE_URL}}/api/seguimientos-psicologicos?fichaPsicologicaId={{FICHA_ID}}
Usar esta seccion si el problema involucra citas posteriores.

Checks rapidos despues de cada paso
-----------------------------------
- Revisar timestamps createdAt/updatedAt en la respuesta de la ficha.
- Confirmar que numeroEvaluacion se mantenga constante desde el Paso 1.
- Si una llamada falla, anotar el payload exacto y el status code antes de continuar.

Comandos curl de ejemplo
------------------------
export BASE="{{BASE_URL}}"
export TOKEN="{{TOKEN}}"

# Paso 1
curl -X POST "$BASE/api/fichas-psicologicas" \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
        "personalMilitarId": {{PERSONAL_ID}},
        "fechaEvaluacion": "2025-01-07",
        "tipoEvaluacion": "Ingreso",
        "estado": "Abierta"
      }'

# Paso 3
curl -X PUT "$BASE/api/fichas-psicologicas/{{FICHA_ID}}/observacion" \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
        "observacionClinica": "Paciente refiere cefaleas frecuentes",
        "motivoConsulta": "Reubicacion operativa",
        "enfermedadActual": "Cefalea tensional recurrente"
      }'

# Paso 10.2
curl -X GET "$BASE/api/seguimientos-psicologicos?fichaPsicologicaId={{FICHA_ID}}" \
  -H "Authorization: Bearer $TOKEN"

Notas finales
-------------
- Si las respuestas llegan sin cambios, validar en la base datos que los campos se actualicen (tabla fichas_psicologicas).
- Revisar logs del servicio para capturar stacktrace cuando se devuelvan 500.
- Usar este checklist de arriba hacia abajo para aislar rapidamente en que paso se rompe el flujo.
