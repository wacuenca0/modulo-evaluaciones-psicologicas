INTEGRACION DE CATALOGO CIE-10 Y ACTUALIZACION DE CONDICION CLINICA
===================================================================

1. PRE-REQUISITOS
-----------------
- Mantener en ejecucion los microservicios `servicio-gestion`, `servicio-catalogos` y el `api-gateway`.
- Autenticar al usuario con rol PSICOLOGO para obtener un token JWT valido.
- Toda llamada protegida debe incluir la cabecera `Authorization: Bearer <token>`.

2. CONSULTA DE DIAGNOSTICOS CIE-10
---------------------------------
- Endpoint: `GET /catalogos/api/catalogo-cie10?soloActivos=true`
- Funcion: Recuperar todos los diagnosticos activos para poblar un autocomplete o lista desplegable.
- Respuesta esperada:
```
[
  {
    "id": 12,
    "codigo": "F41.1",
    "descripcion": "Trastorno de ansiedad generalizada",
    "activo": true
  },
  {
    "id": 37,
    "codigo": "F32.0",
    "descripcion": "Episodio depresivo leve",
    "activo": true
  }
]
```
- Uso: Guardar codigo y descripcion del item que seleccione el usuario. Opcionalmente almacenar el `id` si se requiere reconfirmar la informacion.

3. CONSULTA DE DETALLE POR ID (OPCIONAL)
----------------------------------------
- Endpoint: `GET /catalogos/api/catalogo-cie10/{id}`
- Funcion: Obtener la ficha individual del diagnostico seleccionado si solo se guarda el identificador en el estado del frontend.
- Respuesta esperada:
```
{
  "id": 12,
  "codigo": "F41.1",
  "descripcion": "Trastorno de ansiedad generalizada",
  "activo": true
}
```

4. ACTUALIZACION DE CONDICION CLINICA Y PLAN
--------------------------------------------
- Endpoint: `PUT /gestion/api/fichas-psicologicas/{id}/condicion`
- Cabeceras: `Authorization: Bearer <token>` y `Content-Type: application/json`
- Cuerpo JSON con campos en snake_case, ejemplo para condicion SEGUIMIENTO:
```
{
  "condicion": "Seguimiento",
  "diagnostico_cie10_codigo": "F41.1",
  "diagnostico_cie10_descripcion": "Trastorno de ansiedad generalizada",
  "plan_frecuencia": "Mensual",
  "plan_tipo_sesion": "Individual",
  "plan_detalle": "Sesiones mensuales"
}
```
- Respuesta exitosa incluye la ficha psicologica normalizada, por ejemplo:
```
{
  "id": 45,
  "condicionClinica": "Seguimiento",
  "diagnosticoCie10": {
    "codigo": "F41.1",
    "descripcion": "Trastorno de ansiedad generalizada"
  },
  "planSeguimiento": {
    "frecuencia": "Mensual",
    "tipoSesion": "Individual",
    "detalle": "Sesiones mensuales"
  },
  "...": "otros campos"
}
```

5. REGLAS DE NEGOCIO BACKEND
----------------------------
- Valores validos para `condicion`: `Alta`, `Seguimiento`, `Transferencia`. Se validan contra `CondicionClinicaEnum`.
- `Seguimiento` y `Transferencia` exigen `diagnostico_cie10_codigo`, `plan_frecuencia` y `plan_tipo_sesion`. Falta de estos campos produce error 400.
- `plan_frecuencia` debe coincidir con los tokens de `FrecuenciaSeguimientoEnum` (por ejemplo `Mensual`, `Semanal`, `Personalizada`).
- `plan_tipo_sesion` debe coincidir con `TipoSesionEnum` (por ejemplo `Individual`, `Grupal`, `Mixta`).
- Si `condicion` es `Alta`, el backend limpia diagnostico y plan; se recomienda enviar los campos como `null` para reflejarlo.

6. FLUJO PROPUESTO EN EL FRONTEND
----------------------------------
1. Al cargar la pantalla, consumir `GET /gestion/api/fichas-psicologicas/{id}` para mostrar valores actuales.
2. Poblacion del listado de diagnosticos con `GET /catalogos/api/catalogo-cie10?soloActivos=true`.
3. Cuando el usuario selecciona un diagnostico, guardar `codigo` y `descripcion` en el estado del formulario.
4. Si el usuario cambia `condicion` a `Alta`, deshabilitar campos de diagnostico y plan y limpiar su estado.
5. Si el usuario elige `Seguimiento` o `Transferencia`, forzar la captura de plan y diagnostico antes de habilitar el boton Guardar.
6. Al enviar, utilizar `PUT /gestion/api/fichas-psicologicas/{id}/condicion` con el JSON correspondiente.
7. Tras respuesta 200, refrescar los datos con `GET /gestion/api/fichas-psicologicas/{id}` para mostrar la condicion guardada.

7. PRUEBAS RECOMENDADAS
-----------------------
- Caso feliz `Seguimiento`: codigo y plan completos -> esperar 200.
- Caso feliz `Alta`: envia solo `condicion` y valores `null` para plan/diagnostico -> diagnostico y plan quedan vacios.
- Caso de error: intentar guardar `Seguimiento` sin `diagnostico_cie10_codigo` -> backend responde 400 con mensaje "El codigo CIE-10 es obligatorio...".
- Validar que, tras cada guardado, la informacion mostrada corresponde a los valores normalizados por el backend (cadenas capitalizadas, etc.).

8. LOGICA REPORTE RF015 (ATENCIONES POR PSICOLOGOS)
--------------------------------------------------
- Fuente de datos: `fichas_psicologicas` (uno por evaluacion), `seguimiento_psicologico` (citas posteriores) y `personal_militar` (identifica la unidad).
- Consulta base: agrega `COUNT(DISTINCT f.id)` como total de fichas, `SUM` condicionada para estados ACTIVA/OBSERVACION, `COUNT(DISTINCT s.id)` para seguimientos y `COUNT(DISTINCT f.personalMilitar.id)` para personas unicas.
- Filtros opcionales:
  * `psicologoId`: restringe el `JOIN` por `f.psicologo.id`; si el usuario autenticado es psicologo, se fuerza su propio id.
  * `fechaDesde`/`fechaHasta`: se aplican tanto a `f.fechaEvaluacion` como a `s.fechaSeguimiento`.
  * `diagnosticoCodigo`: compara con `f.diagnosticoCie10.codigo` (upper).
  * `unidadMilitar`: requiere columna en `personal_militar`; se usa `LOWER(pm.unidadMilitar)` para coincidencia case-insensitive.
- Resultado agrupado por psicologo (id, nombre, username) y ordenado alfabeticamente; se calcula `MAX(COALESCE(s.fechaSeguimiento, f.fechaEvaluacion))` como ultima atencion.
- Endpoint: `GET /gestion/api/reportes/atenciones-psicologos` expone los filtros anteriores como query params (`psicologoId`, `fechaDesde`, `fechaHasta`, `diagnosticoCodigo`, `unidadMilitar`).
- Respuesta: lista de `ReporteAtencionPsicologoDTO` con campos `totalFichas`, `fichasActivas`, `fichasObservacion`, `totalSeguimientos`, `personasAtendidas`, `ultimaAtencion`.
- Postman ejemplos:
  1. `GET /gestion/api/reportes/atenciones-psicologos?fechaDesde=2026-01-01&fechaHasta=2026-01-31`
  2. `GET /gestion/api/reportes/atenciones-psicologos?psicologoId=7&diagnosticoCodigo=F41.1`
  3. `GET /gestion/api/reportes/atenciones-psicologos?unidadMilitar=Hospital%20Militar&fechaDesde=2025-10-01`
- Todos los requests deben incluir `Authorization: Bearer <token>` con rol ADMINISTRADOR o PSICOLOGO.

FIN DEL DOCUMENTO
